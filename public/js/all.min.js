function getCanvas(t){return document.getElementById(t)}function getContext(t){return t.getContext("2d")}function initCanvas(t){function a(t){var a=new FileReader;a.onload=function(t){var a=new Image;a.onload=function(){e.width=a.width+80,e.height=a.height+80,r.fillStyle="white",r.fillRect(0,0,e.width,e.height),r.drawImage(a,40,40)},a.src=t.target.result,imageObj.src=t.target.result},a.readAsDataURL(t.target.files[0])}this.canvasId=t;var o=document.getElementById("imageLoader"),e=this.canvas(this.canvasId),r=this.context(e);o.addEventListener("change",a,!1)}function makePixelezation(){function t(t,a,o,e,r,n){var i=t.getImageData(r,n,o,e);a.colors=[];var s=5,l=3;o<200&&(s=2,l=7);var c={data:i.data,pixelation:s,sourceWidth:o,sourceHeight:e,colors:a.colors,colorDiff:l};a.colors=getColors(c),t.putImageData(i,r,n),c.pixelation-=1}var a=this.canvas(this.canvasId),o=this.context(a),e=new Image;return e.onload=function(){var r=e.width,n=e.height,i=a.width/2-r/2,s=a.height/2-n/2;o.drawImage(e,i,s),t(o,this,r,n,i,s),grid.init(a)},e.src=this.src,e}function saveImage(t,a){var o=this.canvas(this.canvasId);this.context(o);t.href=o.toDataURL(),t.download=a}function getColors(t){for(var a,o,e,r,n,i,s,l=[],c=0;c<t.sourceHeight;c+=t.pixelation)for(var h=0;h<t.sourceWidth;h+=t.pixelation){a=t.data[4*(t.sourceWidth*c+h)],o=t.data[4*(t.sourceWidth*c+h)+1],e=t.data[4*(t.sourceWidth*c+h)+2];for(var d=0;d<t.pixelation;d++)for(var u=0;u<t.pixelation;u++)h+u<t.sourceWidth&&(t.data[4*(t.sourceWidth*(c+d)+(h+u))]=a,t.data[4*(t.sourceWidth*(c+d)+(h+u))+1]=o,t.data[4*(t.sourceWidth*(c+d)+(h+u))+2]=e)}for(var c=0;c<4*t.sourceHeight;c+=4)for(var h=0;h<4*t.sourceWidth;h+=4)a=t.data[t.sourceWidth*c+h],o=t.data[t.sourceWidth*c+h+1],e=t.data[t.sourceWidth*c+h+2],r=rgbToXyz(a,o,e),n=xyzToLab(r[0],r[1],r[2]),(s=findSimilar(t.colors,n,t.colorDiff))?s!==!0&&(n=s,r=labtoxyz(n[0],n[1],n[2]),i=xyztorgb(r[0],r[1],r[2]),t.data[t.sourceWidth*c+h]=i[0],t.data[t.sourceWidth*c+h+1]=i[1],t.data[t.sourceWidth*c+h+2]=i[2]):(l.push([a,o,e]),t.colors.push(n));return console.log(l.length),l}function findSimilar(t,a,o){for(var e=a.slice(),r=t.map(function(t){return t.slice()}),n=0;n<r.length;n++){if(r[n].sort().join(",")===e.sort().join(",")){var i=cie1994(e,r[n],!1);return!0}var i=cie1994(e,r[n],!1);if(i<6)return a=t[n]}return!1}function rgbToXyz(t,a,o){var e=t/255,r=a/255,n=o/255;e>.04045?e=Math.pow((e+.055)/1.055,2.4):e/=12.92,r>.04045?r=Math.pow((r+.055)/1.055,2.4):r/=12.92,n>.04045?n=Math.pow((n+.055)/1.055,2.4):n/=12.92,e=100*e,r=100*r,n=100*n;var i=.4124*e+.3576*r+.1805*n,s=.2126*e+.7152*r+.0722*n,l=.0193*e+.1192*r+.9505*n;return[i,s,l]}function xyztorgb(t,a,o){var e=3.2404*t+a*-1.5371+o*-.4985,r=t*-.9692+1.876*a+.04155*o,n=.0556*t+a*-.204+1.0572*o;e/=100,r/=100,n/=100,e>.0031308?e=1.055*Math.pow(e,.416666665)-.055:e/=12.92,r>.0031308?r=1.055*Math.pow(r,.416666665)-.055:r/=12.92,n>.0031308?n=1.055*Math.pow(n,.416666665)-.055:n/=12.92;var i=parseFloat((255*e).toFixed(0)),s=parseFloat((255*r).toFixed(0)),l=parseFloat((255*n).toFixed(0));return[i,s,l]}function xyzToLab(t,a,o){var e=95.047,r=100,n=108.883,i=t/e,s=a/r,l=o/n;i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,l=l>.008856?Math.pow(l,1/3):7.787*l+16/116;var c=116*s-16,h=500*(i-s),d=200*(s-l);return[c,h,d]}function labtoxyz(t,a,o){var e=95.047,r=100,n=108.883,i=(t+16)/116,s=a/500+i,l=i-o/200;s=s>.20689303442296383?Math.pow(s,3):(s-16/116)/7.787,i=i>.20689303442296383?Math.pow(i,3):(i-16/116)/7.787,l=l>.20689303442296383?Math.pow(l,3):(l-16/116)/7.787;var c=e*s,h=r*i,d=n*l;return[c,h,d]}function cie1994(t,a,o){var e,r,n,t={l:t[0],a:t[1],b:t[2]},a={l:a[0],a:a[1],b:a[2]},i=1,s=1;o?(e=.014,r=.048,n=2):(e=.015,r=.045,n=1);var l=Math.sqrt(t.a*t.a+t.b*t.b),c=Math.sqrt(a.a*a.a+a.b*a.b),h=1+e*l,d=1+r*l,u=1,v=t.a-a.a,g=t.b-a.b,f=l-c,p=t.l-a.l,m=Math.sqrt(v*v+g*g-f*f);return Math.sqrt(Math.pow(p/(n*u),2)+Math.pow(f/(s*d),2)+Math.pow(m/(i*h),2))}function drawGridLines(t,a){var o=t.width,e=t.height,r=t.getContext("2d");r.strokeStyle=a.color,r.strokeWidth=1,r.beginPath();var n=null,i=null,s=null,l=null;for(n=Math.floor(o/a.separation),i=1;i<=n;i++)s=i*a.separation,r.moveTo(s,0),r.lineTo(s,e),r.stroke();for(n=Math.floor(e/a.separation),i=1.5;i<=n;i++)l=i*a.separation,r.moveTo(0,l),r.lineTo(o,l),r.stroke();r.closePath()}function drawGrid(t){var a=50.5;t.width<5*a&&(a=20.5);var o={majorLines:{separation:a,color:"#999"}};drawGridLines(t,o.majorLines)}function drawGridLines(t,a){var o=t.width,e=t.height,r=t.getContext("2d");r.strokeStyle=a.color,r.strokeWidth=1,r.beginPath();var n=null,i=null,s=null,l=null;for(n=Math.floor(o/a.separation),i=1;i<=n;i++)s=i%2==0?i*a.separation-.5:i*a.separation,r.moveTo(s,0),r.lineTo(s,e),r.stroke();for(n=Math.floor(e/a.separation),i=1;i<=n;i++)l=i%2?i*a.separation:i*a.separation-.5,r.moveTo(.5,l),r.lineTo(o,l),r.stroke();r.closePath()}function createPallete(t){$("#pallete").empty();var a=t;a.map(function(t){var a=rgbToHex(t[0],t[1],t[2]);$("#pallete").append($("<li>").text(a).append($("<span>").css("background-color",a)))})}function rgbToHex(t,a,o){return"#"+((1<<24)+(t<<16)+(a<<8)+o).toString(16).slice(1)}function randomString(t,a){for(var o="",e=t;e>0;--e)o+=a[Math.round(Math.random()*(a.length-1))];return o}var imageObj={canvasId:"",init:initCanvas,makePixelezation:makePixelezation,saveImage:saveImage,canvas:getCanvas,context:getContext},grid={init:drawGrid};$(document).ready(function(){var t;imageObj.init("myCanvas"),$("#makePixel").on("click",function(){t=imageObj.makePixelezation()}),$("#downloadLnk").on("click",function(){var t=randomString(10,"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789");imageObj.saveImage(this,t+".png")}),$(".getPallete").on("click",function(){createPallete(t.colors)})});