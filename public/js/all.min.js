"use strict";function initCanvas(e){function a(e){var a=new FileReader;a.onload=function(e){var a=new Image;a.onload=function(){n.width=a.width,n.height=a.height,r.drawImage(a,0,0)},a.src=e.target.result,imageObj.src=e.target.result},a.readAsDataURL(e.target.files[0])}var t=document.getElementById("imageLoader"),n=document.getElementById(e);t.addEventListener("change",a,!1);var r=n.getContext("2d")}function makePixelezation(e){function a(e,a,n,r,o,s){for(var i=o,c=s,v=e.getImageData(i,c,n,r),l=v.data,d=0;d<r;d+=t)for(var f=0;f<n;f+=t)for(var m=l[4*(n*d+f)],u=l[4*(n*d+f)+1],g=l[4*(n*d+f)+2],h=0;h<t;h++)for(var w=0;w<t;w++)f+w<n&&(l[4*(n*(d+h)+(f+w))]=m,l[4*(n*(d+h)+(f+w))+1]=u,l[4*(n*(d+h)+(f+w))+2]=g);e.putImageData(v,o,s),t-=1}var t;t=void 0==e?7:e;var n=document.getElementById("myCanvas"),r=n.getContext("2d"),o=new Image;o.onload=function(){var e=o.width,s=o.height,i=n.width/2-e/2,c=n.height/2-s/2;r.drawImage(o,i,c),t<1?clearInterval(intervalId):a(r,o,e,s,i,c)},o.src=this.src}function saveImage(e,a,t){e.href=document.getElementById(a).toDataURL(),e.download=t}function trackTransforms(e){var a=document.createElementNS("http://www.w3.org/2000/svg","svg"),t=a.createSVGMatrix();e.getTransform=function(){return t};var n=[],r=e.save;e.save=function(){return n.push(t.translate(0,0)),r.call(e)};var o=e.restore;e.restore=function(){return t=n.pop(),o.call(e)};var s=e.scale;e.scale=function(a,n){return t=t.scaleNonUniform(a,n),s.call(e,a,n)};var i=e.rotate;e.rotate=function(a){return t=t.rotate(180*a/Math.PI),i.call(e,a)};var c=e.translate;e.translate=function(a,n){return t=t.translate(a,n),c.call(e,a,n)};var v=e.transform;e.transform=function(n,r,o,s,i,c){var l=a.createSVGMatrix();return l.a=n,l.b=r,l.c=o,l.d=s,l.e=i,l.f=c,t=t.multiply(l),v.call(e,n,r,o,s,i,c)};var l=e.setTransform;e.setTransform=function(a,n,r,o,s,i){return t.a=a,t.b=n,t.c=r,t.d=o,t.e=s,t.f=i,l.call(e,a,n,r,o,s,i)};var d=a.createSVGPoint();e.transformedPoint=function(e,a){return d.x=e,d.y=a,d.matrixTransform(t.inverse())}}var imageObj={init:initCanvas,makePixelezation:makePixelezation,saveImage:saveImage};imageObj.init("myCanvas"),$("#makePixel").on("click",function(){imageObj.makePixelezation()}),$("#downloadLnk").on("click",function(){imageObj.saveImage(this,"myCanvas","test.png")});var canvas=document.getElementsByTagName("canvas")[0];canvas.width=800,canvas.height=600;var gkhead=new Image;window.onload=function(){function e(){var e=a.transformedPoint(0,0),t=a.transformedPoint(canvas.width,canvas.height);a.clearRect(e.x,e.y,t.x-e.x,t.y-e.y),a.save(),a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,canvas.width,canvas.height),a.restore(),a.drawImage(gkhead,0,0)}var a=canvas.getContext("2d");trackTransforms(a),e();var t,n,r=canvas.width/2,o=canvas.height/2;canvas.addEventListener("mousedown",function(e){document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",r=e.offsetX||e.pageX-canvas.offsetLeft,o=e.offsetY||e.pageY-canvas.offsetTop,t=a.transformedPoint(r,o),n=!1},!1),canvas.addEventListener("mousemove",function(s){if(r=s.offsetX||s.pageX-canvas.offsetLeft,o=s.offsetY||s.pageY-canvas.offsetTop,n=!0,t){var i=a.transformedPoint(r,o);a.translate(i.x-t.x,i.y-t.y),e()}},!1),canvas.addEventListener("mouseup",function(e){t=null,n||i(e.shiftKey?-1:1)},!1);var s=1.1,i=function(t){var n=a.transformedPoint(r,o);a.translate(n.x,n.y);var i=Math.pow(s,t);a.scale(i,i),a.translate(-n.x,-n.y),e()},c=function(e){var a=e.wheelDelta?e.wheelDelta/40:e.detail?-e.detail:0;return a&&i(a),e.preventDefault()&&!1};canvas.addEventListener("DOMMouseScroll",c,!1),canvas.addEventListener("mousewheel",c,!1)},gkhead.src="http://phrogz.net/tmp/gkhead.jpg";