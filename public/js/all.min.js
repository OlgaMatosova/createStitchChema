function getCanvas(t){return document.getElementById(t)}function getContext(t){return t.getContext("2d")}function initCanvas(t){function n(t){var n=new FileReader;n.onload=function(t){var n=new Image;n.onload=function(){r.width=n.width+80,r.height=n.height+80,o.fillStyle="white",o.fillRect(0,0,r.width,r.height),o.drawImage(n,40,40)},n.src=t.target.result,imageObj.src=t.target.result},n.readAsDataURL(t.target.files[0])}this.canvasId=t;var e=document.getElementById("imageLoader"),r=this.canvas(this.canvasId),o=this.context(r);e.addEventListener("change",n,!1)}function makePixelezation(t){function n(t,n,r,o,a,i){var u=a,c=i,s=t.getImageData(u,c,r,o),f=s.data,l=[];getColors(r,o,e,l,f),console.log(l),t.putImageData(s,a,i),e-=1}var e,r=this.canvas(this.canvasId),o=this.context(r),a=new Image;return e=void 0==t?10:t,a.onload=function(){var t=a.width,i=a.height,u=r.width/2-t/2,c=r.height/2-i/2;o.drawImage(a,u,c),e<1?clearInterval(intervalId):n(o,this,t,i,u,c),grid.init(r)},a.src=this.src,a}function saveImage(t,n){var e=this.canvas(this.canvasId);this.context(e);t.href=e.toDataURL(),t.download=n}function searchForArray(t,n){for(var e=t.map(function(t){return t.slice()}),r=n.slice(0),o=0;o<e.length;o++)if(e[o].sort().join(",")===r.sort().join(","))return!1;return!0}function find(t,n){return t.indexOf(n)>-1}function comparison(t,n){for(var e=0;e<=n.length;e++);}function getColors(t,n,e,r,o){for(var a,i,u,c=0;c<n;c+=e)for(var s=0;s<t;s+=e){a=o[t*c+s],i=o[t*c+s+1],u=o[t*c+s+2];var f=rgbToHex(a,i,u);find(r,f)||r.push(f)}}function drawGridLines(t,n){var e=t.width,r=t.height,o=t.getContext("2d");o.strokeStyle=n.color,o.strokeWidth=1,o.beginPath();var a=null,i=null,u=null,c=null;for(a=Math.floor(e/n.separation),i=1;i<=a;i++)u=i*n.separation,o.moveTo(u,0),o.lineTo(u,r),o.stroke();for(a=Math.floor(r/n.separation),i=1.5;i<=a;i++)c=i*n.separation,o.moveTo(0,c),o.lineTo(e,c),o.stroke();o.closePath()}function drawGrid(t){var n=100.5;t.width<5*n&&(n=30.5);var e={majorLines:{separation:n,color:"#999"}};drawGridLines(t,e.majorLines)}function drawGridLines(t,n){var e=t.width,r=t.height,o=t.getContext("2d");o.strokeStyle=n.color,o.strokeWidth=1,o.beginPath();var a=null,i=null,u=null,c=null;for(a=Math.floor(e/n.separation),i=1;i<=a;i++)u=i%2==0?i*n.separation-.5:i*n.separation,o.moveTo(u,0),o.lineTo(u,r),o.stroke();for(a=Math.floor(r/n.separation),i=1;i<=a;i++)c=i%2?i*n.separation:i*n.separation-.5,o.moveTo(.5,c),o.lineTo(e,c),o.stroke();o.closePath()}function createPallete(t){$("#pallete").empty();var n=new ColorThief,e=n.getPalette(t);e.map(function(t){var n=rgbToHex(t[0],t[1],t[2]);$("#pallete").append($("<li>").text(n).append($("<span>").css("background-color",n)))})}function rgbToHex(t,n,e){return"#"+((1<<24)+(t<<16)+(n<<8)+e).toString(16).slice(1)}function randomString(t,n){for(var e="",r=t;r>0;--r)e+=n[Math.round(Math.random()*(n.length-1))];return e}var imageObj={canvasId:"",init:initCanvas,makePixelezation:makePixelezation,saveImage:saveImage,createPallete:createPallete,canvas:getCanvas,context:getContext},CanvasImage=function(t){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas),this.width=this.canvas.width=t.width,this.height=this.canvas.height=t.height,this.context.drawImage(t,0,0,this.width,this.height)};CanvasImage.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height)},CanvasImage.prototype.update=function(t){this.context.putImageData(t,0,0)},CanvasImage.prototype.getPixelCount=function(){return this.width*this.height},CanvasImage.prototype.getImageData=function(){return this.context.getImageData(0,0,this.width,this.height)},CanvasImage.prototype.removeCanvas=function(){this.canvas.parentNode.removeChild(this.canvas)};var ColorThief=function(){};if(ColorThief.prototype.getColor=function(t,n){var e=this.getPalette(t,5,n),r=e[0];return r},ColorThief.prototype.getPalette=function(t,n,e){"undefined"==typeof n&&(n=10),("undefined"==typeof e||e<1)&&(e=10);for(var r,o,a,i,u,c=new CanvasImage(t),s=c.getImageData(),f=s.data,l=c.getPixelCount(),h=[],v=0;v<l;v+=e)r=4*v,o=f[r+0],a=f[r+1],i=f[r+2],u=f[r+3],u>=125&&(o>250&&a>250&&i>250||h.push([o,a,i]));var g=MMCQ.quantize(h,n),p=g?g.palette():null;return c.removeCanvas(),p},!pv)var pv={map:function(t,n){var e={};return n?t.map(function(t,r){return e.index=r,n.call(e,t)}):t.slice()},naturalOrder:function(t,n){return t<n?-1:t>n?1:0},sum:function(t,n){var e={};return t.reduce(n?function(t,r,o){return e.index=o,t+n.call(e,r)}:function(t,n){return t+n},0)},max:function(t,n){return Math.max.apply(null,n?pv.map(t,n):t)}};var MMCQ=function(){function t(t,n,e){return(t<<2*c)+(n<<c)+e}function n(t){function n(){e.sort(t),r=!0}var e=[],r=!1;return{push:function(t){e.push(t),r=!1},peek:function(t){return r||n(),void 0===t&&(t=e.length-1),e[t]},pop:function(){return r||n(),e.pop()},size:function(){return e.length},map:function(t){return e.map(t)},debug:function(){return r||n(),e}}}function e(t,n,e,r,o,a,i){var u=this;u.r1=t,u.r2=n,u.g1=e,u.g2=r,u.b1=o,u.b2=a,u.histo=i}function r(){this.vboxes=new n(function(t,n){return pv.naturalOrder(t.vbox.count()*t.vbox.volume(),n.vbox.count()*n.vbox.volume())})}function o(n){var e,r,o,a,i=1<<3*c,u=new Array(i);return n.forEach(function(n){r=n[0]>>s,o=n[1]>>s,a=n[2]>>s,e=t(r,o,a),u[e]=(u[e]||0)+1}),u}function a(t,n){var r,o,a,i=1e6,u=0,c=1e6,f=0,l=1e6,h=0;return t.forEach(function(t){r=t[0]>>s,o=t[1]>>s,a=t[2]>>s,r<i?i=r:r>u&&(u=r),o<c?c=o:o>f&&(f=o),a<l?l=a:a>h&&(h=a)}),new e(i,u,c,f,l,h,n)}function i(n,e){function r(t){var n,r,o,a,i,u=t+"1",s=t+"2",f=0;for(c=e[u];c<=e[s];c++)if(g[c]>v/2){for(o=e.copy(),a=e.copy(),n=c-e[u],r=e[s]-c,i=n<=r?Math.min(e[s]-1,~~(c+r/2)):Math.max(e[u],~~(c-1-n/2));!g[i];)i++;for(f=p[i];!f&&g[i-1];)f=p[--i];return o[s]=i,a[u]=o[s]+1,[o,a]}}if(e.count()){var o=e.r2-e.r1+1,a=e.g2-e.g1+1,i=e.b2-e.b1+1,u=pv.max([o,a,i]);if(1==e.count())return[e.copy()];var c,s,f,l,h,v=0,g=[],p=[];if(u==o)for(c=e.r1;c<=e.r2;c++){for(l=0,s=e.g1;s<=e.g2;s++)for(f=e.b1;f<=e.b2;f++)h=t(c,s,f),l+=n[h]||0;v+=l,g[c]=v}else if(u==a)for(c=e.g1;c<=e.g2;c++){for(l=0,s=e.r1;s<=e.r2;s++)for(f=e.b1;f<=e.b2;f++)h=t(s,c,f),l+=n[h]||0;v+=l,g[c]=v}else for(c=e.b1;c<=e.b2;c++){for(l=0,s=e.r1;s<=e.r2;s++)for(f=e.g1;f<=e.g2;f++)h=t(s,f,c),l+=n[h]||0;v+=l,g[c]=v}return g.forEach(function(t,n){p[n]=v-t}),r(u==o?"r":u==a?"g":"b")}}function u(t,e){function u(t,n){for(var e,r=1,o=0;o<f;)if(e=t.pop(),e.count()){var a=i(c,e),u=a[0],s=a[1];if(!u)return;if(t.push(u),s&&(t.push(s),r++),r>=n)return;if(o++>f)return}else t.push(e),o++}if(!t.length||e<2||e>256)return!1;var c=o(t),s=0;c.forEach(function(){s++});var h=a(t,c),v=new n(function(t,n){return pv.naturalOrder(t.count(),n.count())});v.push(h),u(v,l*e);for(var g=new n(function(t,n){return pv.naturalOrder(t.count()*t.volume(),n.count()*n.volume())});v.size();)g.push(v.pop());u(g,e-g.size());for(var p=new r;g.size();)p.push(g.pop());return p}var c=5,s=8-c,f=1e3,l=.75;return e.prototype={volume:function(t){var n=this;return n._volume&&!t||(n._volume=(n.r2-n.r1+1)*(n.g2-n.g1+1)*(n.b2-n.b1+1)),n._volume},count:function(n){var e=this,r=e.histo;if(!e._count_set||n){var o,a,i,u=0;for(o=e.r1;o<=e.r2;o++)for(a=e.g1;a<=e.g2;a++)for(i=e.b1;i<=e.b2;i++)index=t(o,a,i),u+=r[index]||0;e._count=u,e._count_set=!0}return e._count},copy:function(){var t=this;return new e(t.r1,t.r2,t.g1,t.g2,t.b1,t.b2,t.histo)},avg:function(n){var e=this,r=e.histo;if(!e._avg||n){var o,a,i,u,s,f=0,l=1<<8-c,h=0,v=0,g=0;for(a=e.r1;a<=e.r2;a++)for(i=e.g1;i<=e.g2;i++)for(u=e.b1;u<=e.b2;u++)s=t(a,i,u),o=r[s]||0,f+=o,h+=o*(a+.5)*l,v+=o*(i+.5)*l,g+=o*(u+.5)*l;f?e._avg=[~~(h/f),~~(v/f),~~(g/f)]:e._avg=[~~(l*(e.r1+e.r2+1)/2),~~(l*(e.g1+e.g2+1)/2),~~(l*(e.b1+e.b2+1)/2)]}return e._avg},contains:function(t){var n=this,e=t[0]>>s;return gval=t[1]>>s,bval=t[2]>>s,e>=n.r1&&e<=n.r2&&gval>=n.g1&&gval<=n.g2&&bval>=n.b1&&bval<=n.b2}},r.prototype={push:function(t){this.vboxes.push({vbox:t,color:t.avg()})},palette:function(){return this.vboxes.map(function(t){return t.color})},size:function(){return this.vboxes.size()},map:function(t){for(var n=this.vboxes,e=0;e<n.size();e++)if(n.peek(e).vbox.contains(t))return n.peek(e).color;return this.nearest(t)},nearest:function(t){for(var n,e,r,o=this.vboxes,a=0;a<o.size();a++)e=Math.sqrt(Math.pow(t[0]-o.peek(a).color[0],2)+Math.pow(t[1]-o.peek(a).color[1],2)+Math.pow(t[2]-o.peek(a).color[2],2)),(e<n||void 0===n)&&(n=e,r=o.peek(a).color);return r},forcebw:function(){var t=this.vboxes;t.sort(function(t,n){return pv.naturalOrder(pv.sum(t.color),pv.sum(n.color))});var n=t[0].color;n[0]<5&&n[1]<5&&n[2]<5&&(t[0].color=[0,0,0]);var e=t.length-1,r=t[e].color;r[0]>251&&r[1]>251&&r[2]>251&&(t[e].color=[255,255,255])}},{quantize:u}}(),grid={init:drawGrid};$(document).ready(function(){var t;imageObj.init("myCanvas"),$("#makePixel").on("click",function(){t=imageObj.makePixelezation(4)}),$("#downloadLnk").on("click",function(){var t=randomString(10,"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789");imageObj.saveImage(this,t+".png")}),$(".getPallete").on("click",function(){createPallete(t)})});