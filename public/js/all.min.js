function getCanvas(){return document.getElementById(this.canvasId)}function getContext(t){return t.getContext("2d")}function initCanvas(t){function a(t){var a=new FileReader;a.onload=function(t){var a=new Image;a.onload=function(){e.canvas.width=a.width+80,e.canvas.height=a.height+80,e.ctx.fillStyle="white",e.ctx.fillRect(0,0,e.canvas.width,e.canvas.height),e.ctx.drawImage(a,40,40)},a.src=t.target.result,e.src=t.target.result},a.readAsDataURL(t.target.files[0])}var e=this;e.canvasId=t;var o=document.getElementById("imageLoader");e.canvas=document.getElementById(e.canvasId),e.ctx=e.canvas.getContext("2d"),o.addEventListener("change",a,!1)}function makePixelezation(){function t(t,e,o,r,n){var i=a.ctx.getImageData(r,n,e,o);t.colors=[];var c=5,s=3;e<200&&(c=2,s=7);var l={data:i.data,pixelation:c,sourceWidth:e,sourceHeight:o,colors:t.colors,colorDiff:s};t.colors=getColors(l),a.ctx.putImageData(i,r,n),l.pixelation-=1}var a=this,e=new Image;return e.onload=function(){var o=e.width,r=e.height,n=a.canvas.width/2-o/2,i=a.canvas.height/2-r/2;a.ctx.drawImage(e,n,i),t(this,o,r,n,i);new DrawGrid(a.canvas)},e.src=a.src,e}function saveImage(t,a){t.href=this.canvas.toDataURL(),t.download=a}function getColors(t){for(var a,e,o,r,n,i,c,s=[],l=0;l<t.sourceHeight;l+=t.pixelation)for(var d=0;d<t.sourceWidth;d+=t.pixelation){a=t.data[4*(t.sourceWidth*l+d)],e=t.data[4*(t.sourceWidth*l+d)+1],o=t.data[4*(t.sourceWidth*l+d)+2];for(var h=0;h<t.pixelation;h++)for(var u=0;u<t.pixelation;u++)d+u<t.sourceWidth&&(t.data[4*(t.sourceWidth*(l+h)+(d+u))]=a,t.data[4*(t.sourceWidth*(l+h)+(d+u))+1]=e,t.data[4*(t.sourceWidth*(l+h)+(d+u))+2]=o)}for(l=0;l<4*t.sourceHeight;l+=4)for(d=0;d<4*t.sourceWidth;d+=4)a=t.data[t.sourceWidth*l+d],e=t.data[t.sourceWidth*l+d+1],o=t.data[t.sourceWidth*l+d+2],r=rgbToXyz(a,e,o),n=xyzToLab(r[0],r[1],r[2]),(c=findSimilar(t.colors,n,t.colorDiff))?c!==!0&&(n=c,r=labtoxyz(n[0],n[1],n[2]),i=xyztorgb(r[0],r[1],r[2]),t.data[t.sourceWidth*l+d]=i[0],t.data[t.sourceWidth*l+d+1]=i[1],t.data[t.sourceWidth*l+d+2]=i[2]):(s.push([a,e,o]),t.colors.push(n));return s}function findSimilar(t,a,e){for(var o=a.slice(),r=t.map(function(t){return t.slice()}),n=0;n<r.length;n++){if(r[n].sort().join(",")===o.sort().join(",")){var i=cie1994(o,r[n],!1);return!0}var i=cie1994(o,r[n],!1);if(i<6)return a=t[n]}return!1}function rgbToXyz(t,a,e){var o=t/255,r=a/255,n=e/255;o>.04045?o=Math.pow((o+.055)/1.055,2.4):o/=12.92,r>.04045?r=Math.pow((r+.055)/1.055,2.4):r/=12.92,n>.04045?n=Math.pow((n+.055)/1.055,2.4):n/=12.92,o=100*o,r=100*r,n=100*n;var i=.4124*o+.3576*r+.1805*n,c=.2126*o+.7152*r+.0722*n,s=.0193*o+.1192*r+.9505*n;return[i,c,s]}function xyztorgb(t,a,e){var o=3.2404*t+a*-1.5371+e*-.4985,r=t*-.9692+1.876*a+.04155*e,n=.0556*t+a*-.204+1.0572*e;o/=100,r/=100,n/=100,o>.0031308?o=1.055*Math.pow(o,.416666665)-.055:o/=12.92,r>.0031308?r=1.055*Math.pow(r,.416666665)-.055:r/=12.92,n>.0031308?n=1.055*Math.pow(n,.416666665)-.055:n/=12.92;var i=parseFloat((255*o).toFixed(0)),c=parseFloat((255*r).toFixed(0)),s=parseFloat((255*n).toFixed(0));return[i,c,s]}function xyzToLab(t,a,e){var o=95.047,r=100,n=108.883,i=t/o,c=a/r,s=e/n;i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,c=c>.008856?Math.pow(c,1/3):7.787*c+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116;var l=116*c-16,d=500*(i-c),h=200*(c-s);return[l,d,h]}function labtoxyz(t,a,e){var o=95.047,r=100,n=108.883,i=(t+16)/116,c=a/500+i,s=i-e/200;c=c>.20689303442296383?Math.pow(c,3):(c-16/116)/7.787,i=i>.20689303442296383?Math.pow(i,3):(i-16/116)/7.787,s=s>.20689303442296383?Math.pow(s,3):(s-16/116)/7.787;var l=o*c,d=r*i,h=n*s;return[l,d,h]}function cie1994(t,a,e){var o,r,n,t={l:t[0],a:t[1],b:t[2]},a={l:a[0],a:a[1],b:a[2]},i=1,c=1;e?(o=.014,r=.048,n=2):(o=.015,r=.045,n=1);var s=Math.sqrt(t.a*t.a+t.b*t.b),l=Math.sqrt(a.a*a.a+a.b*a.b),d=1+o*s,h=1+r*s,u=1,v=t.a-a.a,g=t.b-a.b,f=s-l,p=t.l-a.l,m=Math.sqrt(v*v+g*g-f*f);return Math.sqrt(Math.pow(p/(n*u),2)+Math.pow(f/(c*h),2)+Math.pow(m/(i*d),2))}function DrawGrid(t){var a=50.5;t.width<5*a&&(a=20.5),this.gridOptions={lines:{separation:a,color:"#999"}},drawGridLines(t,this.gridOptions.lines)}function drawGridLines(t,a){var e=t.width,o=t.height,r=t.getContext("2d");r.strokeStyle=a.color,r.strokeWidth=1,r.beginPath();var n=null,i=null,c=null,s=null;for(n=Math.floor(e/a.separation),i=1;i<=n;i++)c=i*a.separation,r.moveTo(c,0),r.lineTo(c,o),r.stroke();for(n=Math.floor(o/a.separation),i=1.5;i<=n;i++)s=i*a.separation,r.moveTo(0,s),r.lineTo(e,s),r.stroke();r.closePath()}function createPallete(t){$("#pallete").empty();var a=t;a.map(function(t){var a=rgbToHex(t[0],t[1],t[2]);$("#pallete").append($("<li>").text(a).append($("<span>").css("background-color",a)))})}function rgbToHex(t,a,e){return"#"+((1<<24)+(t<<16)+(a<<8)+e).toString(16).slice(1)}function randomString(t,a){for(var e="",o=t;o>0;--o)e+=a[Math.round(Math.random()*(a.length-1))];return e}var imageObj={canvasId:"",init:initCanvas,makePixelezation:makePixelezation,saveImage:saveImage,context:getContext};$(document).ready(function(){var t;imageObj.init("myCanvas"),$("#makePixel").on("click",function(){t=imageObj.makePixelezation()}),$("#downloadLnk").on("click",function(){var t=randomString(10,"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789");imageObj.saveImage(this,t+".png")}),$(".getPallete").on("click",function(){createPallete(t.colors)})});