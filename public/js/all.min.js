function initCanvas(t){function e(t){var e=new FileReader;e.onload=function(t){var e=new Image;e.onload=function(){a.width=e.width,a.height=e.height,r.drawImage(e,0,0)},e.src=t.target.result,imageObj.src=t.target.result},e.readAsDataURL(t.target.files[0])}var n=document.getElementById("imageLoader"),a=document.getElementById(t);n.addEventListener("change",e,!1);var r=a.getContext("2d")}function makePixelezation(t){function e(t,e,a,r,o,i){for(var c=o,u=i,s=t.getImageData(c,u,a,r),v=s.data,f=0;f<r;f+=n)for(var l=0;l<a;l+=n)for(var h=v[4*(a*f+l)],g=v[4*(a*f+l)+1],m=v[4*(a*f+l)+2],d=0;d<n;d++)for(var p=0;p<n;p++)l+p<a&&(v[4*(a*(f+d)+(l+p))]=h,v[4*(a*(f+d)+(l+p))+1]=g,v[4*(a*(f+d)+(l+p))+2]=m);t.putImageData(s,o,i),n-=1}var n;n=void 0==t?7:t;var a=document.getElementById("myCanvas"),r=a.getContext("2d"),o=new Image;o.onload=function(){var t=o.width,i=o.height,c=a.width/2-t/2,u=a.height/2-i/2;r.drawImage(o,c,u),n<1?clearInterval(intervalId):e(r,o,t,i,c,u)},o.src=this.src}function saveImage(t,e,n){t.href=document.getElementById(e).toDataURL(),t.download=n}function rgbToHex(t,e,n){return"#"+((1<<24)+(t<<16)+(e<<8)+n).toString(16).slice(1)}function trackTransforms(t){var e=document.createElementNS("http://www.w3.org/2000/svg","svg"),n=e.createSVGMatrix();t.getTransform=function(){return n};var a=[],r=t.save;t.save=function(){return a.push(n.translate(0,0)),r.call(t)};var o=t.restore;t.restore=function(){return n=a.pop(),o.call(t)};var i=t.scale;t.scale=function(e,a){return n=n.scaleNonUniform(e,a),i.call(t,e,a)};var c=t.rotate;t.rotate=function(e){return n=n.rotate(180*e/Math.PI),c.call(t,e)};var u=t.translate;t.translate=function(e,a){return n=n.translate(e,a),u.call(t,e,a)};var s=t.transform;t.transform=function(a,r,o,i,c,u){var v=e.createSVGMatrix();return v.a=a,v.b=r,v.c=o,v.d=i,v.e=c,v.f=u,n=n.multiply(v),s.call(t,a,r,o,i,c,u)};var v=t.setTransform;t.setTransform=function(e,a,r,o,i,c){return n.a=e,n.b=a,n.c=r,n.d=o,n.e=i,n.f=c,v.call(t,e,a,r,o,i,c)};var f=e.createSVGPoint();t.transformedPoint=function(t,e){return f.x=t,f.y=e,f.matrixTransform(n.inverse())}}var CanvasImage=function(t){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas),this.width=this.canvas.width=t.width,this.height=this.canvas.height=t.height,this.context.drawImage(t,0,0,this.width,this.height)};CanvasImage.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height)},CanvasImage.prototype.update=function(t){this.context.putImageData(t,0,0)},CanvasImage.prototype.getPixelCount=function(){return this.width*this.height},CanvasImage.prototype.getImageData=function(){return this.context.getImageData(0,0,this.width,this.height)},CanvasImage.prototype.removeCanvas=function(){this.canvas.parentNode.removeChild(this.canvas)};var ColorThief=function(){};if(ColorThief.prototype.getColor=function(t,e){var n=this.getPalette(t,5,e),a=n[0];return a},ColorThief.prototype.getPalette=function(t,e,n){"undefined"==typeof e&&(e=10),("undefined"==typeof n||n<1)&&(n=10);for(var a,r,o,i,c,u=new CanvasImage(t),s=u.getImageData(),v=s.data,f=u.getPixelCount(),l=[],h=0;h<f;h+=n)a=4*h,r=v[a+0],o=v[a+1],i=v[a+2],c=v[a+3],c>=125&&(r>250&&o>250&&i>250||l.push([r,o,i]));var g=MMCQ.quantize(l,e),m=g?g.palette():null;return u.removeCanvas(),m},!pv)var pv={map:function(t,e){var n={};return e?t.map(function(t,a){return n.index=a,e.call(n,t)}):t.slice()},naturalOrder:function(t,e){return t<e?-1:t>e?1:0},sum:function(t,e){var n={};return t.reduce(e?function(t,a,r){return n.index=r,t+e.call(n,a)}:function(t,e){return t+e},0)},max:function(t,e){return Math.max.apply(null,e?pv.map(t,e):t)}};var MMCQ=function(){function t(t,e,n){return(t<<2*u)+(e<<u)+n}function e(t){function e(){n.sort(t),a=!0}var n=[],a=!1;return{push:function(t){n.push(t),a=!1},peek:function(t){return a||e(),void 0===t&&(t=n.length-1),n[t]},pop:function(){return a||e(),n.pop()},size:function(){return n.length},map:function(t){return n.map(t)},debug:function(){return a||e(),n}}}function n(t,e,n,a,r,o,i){var c=this;c.r1=t,c.r2=e,c.g1=n,c.g2=a,c.b1=r,c.b2=o,c.histo=i}function a(){this.vboxes=new e(function(t,e){return pv.naturalOrder(t.vbox.count()*t.vbox.volume(),e.vbox.count()*e.vbox.volume())})}function r(e){var n,a,r,o,i=1<<3*u,c=new Array(i);return e.forEach(function(e){a=e[0]>>s,r=e[1]>>s,o=e[2]>>s,n=t(a,r,o),c[n]=(c[n]||0)+1}),c}function o(t,e){var a,r,o,i=1e6,c=0,u=1e6,v=0,f=1e6,l=0;return t.forEach(function(t){a=t[0]>>s,r=t[1]>>s,o=t[2]>>s,a<i?i=a:a>c&&(c=a),r<u?u=r:r>v&&(v=r),o<f?f=o:o>l&&(l=o)}),new n(i,c,u,v,f,l,e)}function i(e,n){function a(t){var e,a,r,o,i,c=t+"1",s=t+"2",v=0;for(u=n[c];u<=n[s];u++)if(g[u]>h/2){for(r=n.copy(),o=n.copy(),e=u-n[c],a=n[s]-u,i=e<=a?Math.min(n[s]-1,~~(u+a/2)):Math.max(n[c],~~(u-1-e/2));!g[i];)i++;for(v=m[i];!v&&g[i-1];)v=m[--i];return r[s]=i,o[c]=r[s]+1,[r,o]}}if(n.count()){var r=n.r2-n.r1+1,o=n.g2-n.g1+1,i=n.b2-n.b1+1,c=pv.max([r,o,i]);if(1==n.count())return[n.copy()];var u,s,v,f,l,h=0,g=[],m=[];if(c==r)for(u=n.r1;u<=n.r2;u++){for(f=0,s=n.g1;s<=n.g2;s++)for(v=n.b1;v<=n.b2;v++)l=t(u,s,v),f+=e[l]||0;h+=f,g[u]=h}else if(c==o)for(u=n.g1;u<=n.g2;u++){for(f=0,s=n.r1;s<=n.r2;s++)for(v=n.b1;v<=n.b2;v++)l=t(s,u,v),f+=e[l]||0;h+=f,g[u]=h}else for(u=n.b1;u<=n.b2;u++){for(f=0,s=n.r1;s<=n.r2;s++)for(v=n.g1;v<=n.g2;v++)l=t(s,v,u),f+=e[l]||0;h+=f,g[u]=h}return g.forEach(function(t,e){m[e]=h-t}),a(c==r?"r":c==o?"g":"b")}}function c(t,n){function c(t,e){for(var n,a=1,r=0;r<v;)if(n=t.pop(),n.count()){var o=i(u,n),c=o[0],s=o[1];if(!c)return;if(t.push(c),s&&(t.push(s),a++),a>=e)return;if(r++>v)return}else t.push(n),r++}if(!t.length||n<2||n>256)return!1;var u=r(t),s=0;u.forEach(function(){s++});var l=o(t,u),h=new e(function(t,e){return pv.naturalOrder(t.count(),e.count())});h.push(l),c(h,f*n);for(var g=new e(function(t,e){return pv.naturalOrder(t.count()*t.volume(),e.count()*e.volume())});h.size();)g.push(h.pop());c(g,n-g.size());for(var m=new a;g.size();)m.push(g.pop());return m}var u=5,s=8-u,v=1e3,f=.75;return n.prototype={volume:function(t){var e=this;return e._volume&&!t||(e._volume=(e.r2-e.r1+1)*(e.g2-e.g1+1)*(e.b2-e.b1+1)),e._volume},count:function(e){var n=this,a=n.histo;if(!n._count_set||e){var r,o,i,c=0;for(r=n.r1;r<=n.r2;r++)for(o=n.g1;o<=n.g2;o++)for(i=n.b1;i<=n.b2;i++)index=t(r,o,i),c+=a[index]||0;n._count=c,n._count_set=!0}return n._count},copy:function(){var t=this;return new n(t.r1,t.r2,t.g1,t.g2,t.b1,t.b2,t.histo)},avg:function(e){var n=this,a=n.histo;if(!n._avg||e){var r,o,i,c,s,v=0,f=1<<8-u,l=0,h=0,g=0;for(o=n.r1;o<=n.r2;o++)for(i=n.g1;i<=n.g2;i++)for(c=n.b1;c<=n.b2;c++)s=t(o,i,c),r=a[s]||0,v+=r,l+=r*(o+.5)*f,h+=r*(i+.5)*f,g+=r*(c+.5)*f;v?n._avg=[~~(l/v),~~(h/v),~~(g/v)]:n._avg=[~~(f*(n.r1+n.r2+1)/2),~~(f*(n.g1+n.g2+1)/2),~~(f*(n.b1+n.b2+1)/2)]}return n._avg},contains:function(t){var e=this,n=t[0]>>s;return gval=t[1]>>s,bval=t[2]>>s,n>=e.r1&&n<=e.r2&&gval>=e.g1&&gval<=e.g2&&bval>=e.b1&&bval<=e.b2}},a.prototype={push:function(t){this.vboxes.push({vbox:t,color:t.avg()})},palette:function(){return this.vboxes.map(function(t){return t.color})},size:function(){return this.vboxes.size()},map:function(t){for(var e=this.vboxes,n=0;n<e.size();n++)if(e.peek(n).vbox.contains(t))return e.peek(n).color;return this.nearest(t)},nearest:function(t){for(var e,n,a,r=this.vboxes,o=0;o<r.size();o++)n=Math.sqrt(Math.pow(t[0]-r.peek(o).color[0],2)+Math.pow(t[1]-r.peek(o).color[1],2)+Math.pow(t[2]-r.peek(o).color[2],2)),(n<e||void 0===e)&&(e=n,a=r.peek(o).color);return a},forcebw:function(){var t=this.vboxes;t.sort(function(t,e){return pv.naturalOrder(pv.sum(t.color),pv.sum(e.color))});var e=t[0].color;e[0]<5&&e[1]<5&&e[2]<5&&(t[0].color=[0,0,0]);var n=t.length-1,a=t[n].color;a[0]>251&&a[1]>251&&a[2]>251&&(t[n].color=[255,255,255])}},{quantize:c}}(),imageObj={init:initCanvas,makePixelezation:makePixelezation,saveImage:saveImage};imageObj.init("myCanvas"),$("#makePixel").on("click",function(){imageObj.makePixelezation()}),$("#downloadLnk").on("click",function(){imageObj.saveImage(this,"myCanvas","test.png")}),$(".getPallete").on("click",function(){var t=document.getElementById("myCanvas"),e=t.toDataURL(),n=document.createElement("img");n.src=e;var a=new ColorThief,r=[];r=a.getPalette(n,8),r.map(function(t){var e=rgbToHex(t[0],t[1],t[2]);console.log(e),$("#pallete").append($("<li>").text(e).append($("<span>").css("background-color",e)))})});var canvas=document.getElementsByTagName("canvas")[0];canvas.width=800,canvas.height=600;var gkhead=new Image;window.onload=function(){function t(){var t=e.transformedPoint(0,0),n=e.transformedPoint(canvas.width,canvas.height);e.clearRect(t.x,t.y,n.x-t.x,n.y-t.y),e.save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,canvas.width,canvas.height),e.restore(),e.drawImage(gkhead,0,0)}var e=canvas.getContext("2d");trackTransforms(e),t();var n,a,r=canvas.width/2,o=canvas.height/2;canvas.addEventListener("mousedown",function(t){document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",r=t.offsetX||t.pageX-canvas.offsetLeft,o=t.offsetY||t.pageY-canvas.offsetTop,n=e.transformedPoint(r,o),a=!1},!1),canvas.addEventListener("mousemove",function(i){if(r=i.offsetX||i.pageX-canvas.offsetLeft,o=i.offsetY||i.pageY-canvas.offsetTop,a=!0,n){var c=e.transformedPoint(r,o);e.translate(c.x-n.x,c.y-n.y),t()}},!1),canvas.addEventListener("mouseup",function(t){n=null,a||c(t.shiftKey?-1:1)},!1);var i=1.1,c=function(n){var a=e.transformedPoint(r,o);e.translate(a.x,a.y);var c=Math.pow(i,n);e.scale(c,c),e.translate(-a.x,-a.y),t()},u=function(t){var e=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;return e&&c(e),t.preventDefault()&&!1};canvas.addEventListener("DOMMouseScroll",u,!1),canvas.addEventListener("mousewheel",u,!1)},gkhead.src="http://phrogz.net/tmp/gkhead.jpg";